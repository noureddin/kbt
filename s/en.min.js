const t=["1","2","3","4","5","6"].map(e=>"Lesson&ensp;"+e),y=(e,t)=>t?Math.round(e*10**t)/10**t:Math.round(e),w=e=>e.toString(),f=e=>+e,p=["letter","letters"],v=L.split(" ");function l(e){let t=e.length;for(var n;0!=t;)n=Math.floor(Math.random()*t),t--,[e[t],e[n]]=[e[n],e[t]];return e}const i=(e,t,n="")=>e.filter(e=>e.match(RegExp(`^[${t.replace(/-/g,"\\-")}]+$`))).filter(e=>!e.match(RegExp(`^[${n.replace(/-/g,"\\-")}]+$`))),m=()=>(new Date).getTime(),b=e=>document.querySelectorAll(e),a=t=>b("."+t).forEach(e=>e.classList.remove(t)),E=n=>{n.innerHTML=n.innerText.split("").map(e=>`<span>${e}</span>`).join(""),n.childNodes.forEach((e,t)=>{0<t&&(n.childNodes[t-1].textContent,e.textContent)})},S=(e,t)=>e.classList.add(t),K=(e,t)=>e.classList.remove(t),x=e=>{S(e,"current-word"),E(e),e.scrollIntoView(),$=e},T=document.getElementById("completed"),n=document.getElementById("allwords"),r=document.getElementById("lesson"),k=document.getElementById("screen"),I=document.getElementById("write"),B=document.body;let $,s={};function C(){var e,t;if($)return(e=$.innerText)===(t=I.value)?" ":e.startsWith(t)?e[t.length]:"\b"}b("#keyboard > span > *").forEach(e=>{var t;s["BS"===(t=e.innerHTML)?"\b":"SPACE"===t?" ":t.startsWith("&nbsp;")?t.split(";").pop():t[0]]=e});const H=function(){let r;return{end:function(){clearInterval(r)},start:function(){clearInterval(r),a("hihi");var e,t=C();const n=s[t];n&&(e=()=>n.classList.add("hihi"),"\b"===t?e():r=setInterval(e,5e3))}}}();function R(e,t){t||=f(n.innerText);t=(--t).toString().length;T.innerText=w(e.toString().padStart(t,"0"))}const W=e=>'<a href="?'+e+'">'+t[+e-1]+"</a>";function play(h){var o,e;(h=!h||h<1?1:h)>=v.length&&(h=v.length),window.location.hash=h,window.location.search="",o=r.value=h,k.innerHTML=(e=>{e=+o-1;var t=v[e],[n,r]=[FULL_WORDS,100],e=v.slice(0,e).reduce((e,t)=>e+t,""),e=i(n,t,e);return l(e.length>=r?l(e).slice(0,r):[...e,...l(i(n,t)).slice(0,r-e.length)])})().map(e=>`<span style="display: inline-block; width: ${.75*e.length}em">${e}</span>`).join(" "),R(0,(e=o,v[+e-1],100)),n.innerText=w(100),K(B,"finish"),a("hi"),e=h,v[+e-1].split("").forEach(e=>s[e].classList.add("hi")),x(document.querySelector("#screen > :first-child")),I.value="",I.focus(),H.start();let u,g=0;I.oninput=e=>{e=" "===e.data;null==u&&(u=m());var t,n,r,o,l,i,a,s=$.textContent,c=I.value.trim();I.value=c;for(let e=0;e<s.length;++e){var d=$.childNodes[e];null==c[e]?(K(d,"wrong-letter"),K(d,"correct-letter")):s[e]!==c[e]?(t=d,S(t,"wrong-letter"),K(t,"correct-letter")):(t=d,K(t,"wrong-letter"),S(t,"correct-letter"))}(c.length>s.length||b(".wrong-letter").length||"\b"===C()?S:K)($,"wrong-word"),e?(e=s===c,$.innerHTML=$.textContent,e?(S($,"correct-word"),K($,"wrong-word"),K($,"current-word"),(e=$.nextSibling?.nextSibling)?(R(f(T.innerText)+1),x(e)):(e=(m()-u)/1e3,a=k.innerText.length,S(B,"finish"),k.innerHTML=([l,r,,,o]=[...a=[n=60*(a=a)/e,n/5,a,e,n=100-100*g/a,g,+(e=h)]],l=y(l),i=p,w(l)+" "+(0!==l&&1===l?i[0]:i[1])+" per minute ("+w(y(r))+" WPM with accuracy of "+w(y(o))+"%)."+(+e<v.length?(e,t,n,r,o,l,i)=>"<br>Step to "+W(i+1)+" or repeat "+W(i)+".":(e,t,n,r,o,l,i)=>"<br>You have finish all lessons! You can go now, or repeat "+W(i)+".")(...a)+(90<=n?"":([,,,,,,l]=[...a],"<br>but with this accuracy, it's probably better to repeat "+W(l)+"."))),u=void 0,H.end(),I.oninput=()=>{})):c?(S($,"wrong-word"),E($),g+=1):E($),I.value=""):g+="\b"===C(),u&&H.start()}}function o(e,t){var n,r,o;t&&(n=e.selectionStart,o=e.selectionEnd,r=e.value.substring(0,n),o=e.value.substring(o,e.value.length),e.value=r+t+o,e.selectionStart=e.selectionEnd=n+t.length)}const c={Backquote:!0,KeyQ:!0,KeyW:!0,KeyE:!0,KeyR:!0,KeyT:!0,KeyA:!0,KeyS:!0,KeyD:!0,KeyF:!0,KeyG:!0,KeyZ:!0,KeyX:!0,KeyC:!0,KeyV:!0,KeyB:!0};let d;I.addEventListener("keydown",e=>{var t,n=document.getElementById("emu").checked;"Shift"===e.key?d=e.code.substr(5,1):"Enter"===e.key?alert("Use Space after each word; it's faster, and it's the usual choice"):!n||e.ctrlKey||e.altKey||(n=M[e.code])&&(e.preventDefault(),e.shiftKey?(t=c[e.code])&&"L"===d?alert("Use the right-side Shift with keys on the left side of the keyboard"):t||"R"!==d?o(I,n[1]):alert("Use the left-side Shift with keys on the right side of the keyboard"):o(I,n[0]),I.oninput(e))}),window.addEventListener("resize",()=>{$&&$.scrollIntoView()}),window.addEventListener("load",()=>{I.value="",play(+window.location.hash.slice(1)||+window.location.search.slice(1)||1)});
