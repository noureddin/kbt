const n=e=>e.replace(/[ًٌٍَُِّْ]/g,""),l=FULL_WORDS.map(n).filter((e,t,n)=>e!==n[t-1]),a=e=>e.match(/[ًٌٍَُِّْ]/),i=Math.round(50),t=["أول","ثاني","ثالث","رابع","خامس","سادس","سابع","ثامن","أخير"].map(e=>"الدرس&ensp;ال"+e),c=e=>Math.round(e),s=e=>[...e.toString()].map(e=>String.fromCharCode(e.charCodeAt(0)+1584)).join(""),h=e=>+[...e].map(e=>String.fromCharCode(e.charCodeAt(0)-1584)).join(""),u=(e,t,n,r,o,l)=>{return e=c(e),s(e)+" "+(2===e?"حرفين":2<e%100&&e%100<11?"أحرف":"حرف")+" في الدقيقة ("+s(c(t))+" ك/د بصحة "+s(c(o))+"٪)."},d=(e,t,n,r,o,l,a)=>"<br>تقدم إلى "+D(a+1)+" أو أعد "+D(a)+".",q=(e,t,n,r,o,l,a)=>"<br>لقد أنهيت جميع الدروس! يمكنك الانطلاق، أو إعادة "+D(a)+".",F=(e,t,n,r,o,l,a)=>"<br>ولكن بهذه الصحة القليلة، الأفضل أن تعيد "+D(a)+".",g=L.split(" ");function p(e){let t=e.length;for(var n;0!=t;)n=Math.floor(Math.random()*t),t--,[e[t],e[n]]=[e[n],e[t]];return e}const f=(e,t,n="")=>e.filter(e=>e.match(RegExp(`^[${t.replace(/-/g,"\\-")}]+$`))).filter(e=>!e.match(RegExp(`^[${n.replace(/-/g,"\\-")}]+$`))),N=e=>g[+e-1],V=e=>a(g[+e-1])?i:100,O=(e,t)=>{e=+e-1;var n=g[e],[r,o]=a(n)?[FULL_WORDS,i]:[l,100],t=t||o,o=g.slice(0,e).reduce((e,t)=>e+t,""),e=f(r,n,o);return p(e.length>=t?p(e).slice(0,t):[...e,...p(f(r,n)).slice(0,t-e.length)])},m=()=>(new Date).getTime(),P=e=>document.querySelector(e),r=e=>document.getElementById(e),v=e=>document.querySelectorAll(e),o=t=>v("."+t).forEach(e=>e.classList.remove(t)),w=n=>{n.innerHTML=n.innerText.split("").map(e=>`<span>${e}</span>`).join(""),n.childNodes.forEach((e,t)=>{0<t&&(n.childNodes[t-1].textContent+e.textContent).match(/ل[اأإآ]|[لم]م/)&&b(e,"bb")})},b=(e,t)=>e.classList.add(t),S=(e,t)=>e.classList.remove(t),y=e=>{b(e,"current-word"),w(e),e.scrollIntoView(),$=e},U=e=>{S(e,"wrong-letter"),b(e,"correct-letter")},_=e=>{b(e,"wrong-letter"),S(e,"correct-letter")},x=r("completed"),E=r("allwords"),z=r("lesson"),T=r("screen"),C=r("write"),k=document.body;let $,H={};function I(){var e,t;if($)return(e=$.innerText)===(t=C.value)?" ":e.startsWith(t)?e[t.length]:"\b"}v("#keyboard > span > *").forEach(e=>{var t;H["BS"===(t=e.innerHTML)?"\b":"SPACE"===t?" ":t.startsWith("&nbsp;")?t.split(";").pop():t[0]]=e});const R=function(){let r;return{end:function(){clearInterval(r)},start:function(){clearInterval(r),o("hihi");var e,t=I();const n=H[t];n&&(e=()=>n.classList.add("hihi"),"\b"===t?e():r=setInterval(e,5e3))}}}();function A(e,t){t||=h(E.innerText);t=(--t).toString().length;x.innerText=s(e.toString().padStart(t,"0"))}const D=e=>'<a href="#'+e+'" onclick="'+W.name+"("+e+')">'+t[+e-1]+"</a>";function W(a){var e;(a=!a||a<1?1:a)>=g.length&&(a=g.length),e=z.value=a,T.innerHTML=O(e).map(e=>`<span style="display: inline-block; width: ${.75*n(e).length}em">${e}</span>`).join(" "),A(0,e=V(e)),E.innerText=s(e),S(k,"finish"),o("hi"),N(a).split("").forEach(e=>H[e].classList.add("hi")),y(P("#screen > :first-child")),C.value="",C.focus(),R.start();let i,t,c=0;onblur=()=>{null!=i&&(t=m())},onfocus=()=>{null!=i&&(null==t?console.warn("How on Earth have you managed to start the lesson while not focusing the screen? Please share you wisdom and report this at https://github.com/noureddin/kbt"):i+=m()-t)},C.oninput=e=>{e=" "===e.data;null==i&&(i=m());var t,n,r=$.textContent,o=C.value.trim();C.value=o;for(let e=0;e<r.length;++e){var l=$.childNodes[e];null==o[e]?(S(l,"wrong-letter"),S(l,"correct-letter")):(r[e]!==o[e]?_:U)(l)}(o.length>r.length||v(".wrong-letter").length||"\b"===I()?b:S)($,"wrong-word"),e?(e=r===o,$.innerHTML=$.textContent,e?(b($,"correct-word"),S($,"wrong-word"),S($,"current-word"),(e=$.nextSibling?.nextSibling)?(A(h(x.innerText)+1),y(e)):(e=(m()-i)/1e3,n=T.innerText.length,b(k,"finish"),T.innerHTML=(n=[t=60*(n=n)/e,t/5,n,e,t=100-100*c/n,c,+(e=a)],u(...n)+(+e<g.length?d:q)(...n)+(90<=t?"":F(...n))),i=null,R.end(),C.oninput=null)):o?(b($,"wrong-word"),w($),c+=1):w($),C.value=""):c+="\b"===I(),i&&R.start()}}function j(e,t){var n,r,o;t&&(n=e.selectionStart,o=e.selectionEnd,r=e.value.substring(0,n),o=e.value.substring(o,e.value.length),e.value=r+t+o,e.selectionStart=e.selectionEnd=n+t.length)}const B={Backquote:!0};"QWERTASDFGZXCVB".split("").forEach(e=>B["Key"+e]=!0);let K;C.onkeydown=e=>{var t,n=r("emu").checked;e.ctrlKey||e.altKey||("Shift"===e.key?K=e.code.substr(5,1):"Enter"===e.key?alert("اضغط زر المسافة بعد كل كلمة، فهو أسرع، وهو المعتاد"):n&&(n=M[e.code])&&(e.preventDefault(),e.shiftKey?(t=B[e.code])&&"L"===K?alert("استخدم زر العالي الأيمن مع الأزرار التي على يسار اللوحة"):t||"R"!==K?j(C,n[1]):alert("استخدم زر العالي الأيسر مع الأزرار التي على يمين اللوحة"):j(C,n[0]),C.oninput(e)))},onresize=()=>{$&&$.scrollIntoView()},onload=()=>{var e=+location.hash.slice(1)||+location.search.slice(1)||1;location.search?(location.hash=e,location.search=""):(onhashchange=onload,W(e))};