const a=FULL_WORDS.map(e=>e.replace(/[ًٌٍَُِّْ]/g,"")).filter((e,t,n)=>e!==n[t-1]),o=e=>e.match(/[ًٌٍَُِّْ]/),c=Math.round(50),t=["الأول","الثاني","الثالث","الرابع","الخامس","السادس","السابع","الثامن","الأخير"].map(e=>"الدرس&ensp;"+e),p=(e,t)=>t?Math.round(e*10**t)/10**t:Math.round(e),y=e=>e.toString().replace(/0/g,"٠").replace(/1/g,"١").replace(/2/g,"٢").replace(/3/g,"٣").replace(/4/g,"٤").replace(/5/g,"٥").replace(/6/g,"٦").replace(/7/g,"٧").replace(/8/g,"٨").replace(/9/g,"٩"),w=e=>+e.replace(/٠/g,"0").replace(/١/g,"1").replace(/٢/g,"2").replace(/٣/g,"3").replace(/٤/g,"4").replace(/٥/g,"5").replace(/٦/g,"6").replace(/٧/g,"7").replace(/٨/g,"8").replace(/٩/g,"9"),m=["حرف","حرف","حرفين","أحرف","حرفًا","حرف"],v=L.split(" ");function i(e){let t=e.length;for(var n;0!=t;)n=Math.floor(Math.random()*t),t--,[e[t],e[n]]=[e[n],e[t]];return e}const s=(e,t,n="")=>e.filter(e=>e.match(RegExp(`^[${t.replace(/-/g,"\\-")}]+$`))).filter(e=>!e.match(RegExp(`^[${n.replace(/-/g,"\\-")}]+$`))),f=()=>(new Date).getTime(),E=e=>document.querySelectorAll(e),d=t=>E("."+t).forEach(e=>e.classList.remove(t)),b=n=>{n.innerHTML=n.innerText.split("").map(e=>`<span>${e}</span>`).join(""),n.childNodes.forEach((e,t)=>{0<t&&(n.childNodes[t-1].textContent+e.textContent).match(/ل[اأإآ]|[لم]م/)&&K(e,"bb")})},K=(e,t)=>e.classList.add(t),S=(e,t)=>e.classList.remove(t),x=e=>{K(e,"current-word"),b(e),e.scrollIntoView(),$=e},T=document.getElementById("completed"),n=document.getElementById("allwords"),r=document.getElementById("lesson"),I=document.getElementById("screen"),B=document.getElementById("write"),k=document.body;let $,C={};function R(){var e,t;if($)return(e=$.innerText)===(t=B.value)?" ":e.startsWith(t)?e[t.length]:"\b"}E("#keyboard > span > *").forEach(e=>{var t;C["BS"===(t=e.innerHTML)?"\b":"SPACE"===t?" ":t.startsWith("&nbsp;")?t.split(";").pop():t[0]]=e});const D=function(){let r;return{end:function(){clearInterval(r)},start:function(){clearInterval(r),d("hihi");var e,t=R();const n=C[t];n&&(e=()=>n.classList.add("hihi"),"\b"===t?e():r=setInterval(e,5e3))}}}();function H(e,t){t||=w(n.innerText);t=(--t).toString().length;T.innerText=y(e.toString().padStart(t,"0"))}const W=e=>'<a href="?'+e+'">'+t[+e-1]+"</a>";function play(g){var l,e;(g=!g||g<1?1:g)>=v.length&&(g=v.length),window.location.hash=g,window.location.search="",l=r.value=g,I.innerHTML=(e=>{e=+l-1;var t=v[e],[n,r]=o(t)?[FULL_WORDS,c]:[a,100],e=v.slice(0,e).reduce((e,t)=>e+t,""),e=s(n,t,e);return i(e.length>=r?i(e).slice(0,r):[...e,...i(s(n,t)).slice(0,r-e.length)])})().map(e=>`<span style="display: inline-block; width: ${.75*e.length}em">${e}</span>`).join(" "),H(0,(e=l,e=o(v[+e-1])?c:100)),n.innerText=y(e),S(k,"finish"),d("hi"),e=g,v[+e-1].split("").forEach(e=>C[e].classList.add("hi")),x(document.querySelector("#screen > :first-child")),B.value="",B.focus(),D.start();let h,u=0;B.oninput=e=>{e=" "===e.data;null==h&&(h=f());var t,n,r,l,a,o,c,i=$.textContent,s=B.value.trim();B.value=s;for(let e=0;e<i.length;++e){var d=$.childNodes[e];null==s[e]?(S(d,"wrong-letter"),S(d,"correct-letter")):i[e]!==s[e]?(t=d,K(t,"wrong-letter"),S(t,"correct-letter")):(t=d,S(t,"wrong-letter"),K(t,"correct-letter"))}(s.length>i.length||E(".wrong-letter").length||"\b"===R()?K:S)($,"wrong-word"),e?(e=i===s,$.innerHTML=$.textContent,e?(K($,"correct-word"),S($,"wrong-word"),S($,"current-word"),(e=$.nextSibling?.nextSibling)?(H(w(T.innerText)+1),x(e)):(e=(f()-h)/1e3,c=I.innerText.length,K(k,"finish"),I.innerHTML=([a,r,,,l]=[...c=[n=60*(c=c)/e,n/5,c,e,n=100-100*u/c,u,+(e=g)]],a=p(a),o=m,y(a)+" "+(0===a?o[0]:1===a?o[1]:2===a?o[2]:a%100==0?o[5]:a%100<11?o[3]:o[4])+" في الدقيقة ("+y(p(r))+" ك/د بصحة "+y(p(l))+"٪)."+(+e<v.length?(e,t,n,r,l,a,o)=>"<br>تقدم إلى "+W(o+1)+" أو أعد "+W(o)+".":(e,t,n,r,l,a,o)=>"<br>لقد أنهيت جميع الدروس! يمكنك الانطلاق، أو إعادة "+W(o)+".")(...c)+(90<=n?"":([,,,,,,a]=[...c],"<br>ولكن بهذه الصحة القليلة، الأفضل أن تعيد "+W(a)+"."))),h=void 0,D.end(),B.oninput=()=>{})):s?(K($,"wrong-word"),b($),u+=1):b($),B.value=""):u+="\b"===R(),h&&D.start()}}function l(e,t){var n,r,l;t&&(n=e.selectionStart,l=e.selectionEnd,r=e.value.substring(0,n),l=e.value.substring(l,e.value.length),e.value=r+t+l,e.selectionStart=e.selectionEnd=n+t.length)}const g={Backquote:!0,KeyQ:!0,KeyW:!0,KeyE:!0,KeyR:!0,KeyT:!0,KeyA:!0,KeyS:!0,KeyD:!0,KeyF:!0,KeyG:!0,KeyZ:!0,KeyX:!0,KeyC:!0,KeyV:!0,KeyB:!0};let h;B.addEventListener("keydown",e=>{var t,n=document.getElementById("emu").checked;"Shift"===e.key?h=e.code.substr(5,1):"Enter"===e.key?alert("اضغط زر المسافة بعد كل كلمة، فهو أسرع، وهو المعتاد"):!n||e.ctrlKey||e.altKey||(n=M[e.code])&&(e.preventDefault(),e.shiftKey?(t=g[e.code])&&"L"===h?alert("استخدم زر العالي الأيمن مع الأزرار التي على يسار اللوحة"):t||"R"!==h?l(B,n[1]):alert("استخدم زر العالي الأيسر مع الأزرار التي على يمين اللوحة"):l(B,n[0]),B.oninput(e))}),window.addEventListener("resize",()=>{$&&$.scrollIntoView()}),window.addEventListener("load",()=>{B.value="",play(+window.location.hash.slice(1)||+window.location.search.slice(1)||1)});
