const a=FULL_WORDS.map(e=>e.replace(/[ًٌٍَُِّْ]/g,"")).filter((e,t,n)=>e!==n[t-1]),o=e=>e.match(/[ًٌٍَُِّْ]/),c=Math.round(50),t=["أول","ثاني","ثالث","رابع","خامس","سادس","سابع","ثامن","أخير"].map(e=>"الدرس&ensp;ال"+e),i=e=>Math.round(e),s=e=>e.toString().replace(/0/g,"٠").replace(/1/g,"١").replace(/2/g,"٢").replace(/3/g,"٣").replace(/4/g,"٤").replace(/5/g,"٥").replace(/6/g,"٦").replace(/7/g,"٧").replace(/8/g,"٨").replace(/9/g,"٩"),h=e=>+e.replace(/٠/g,"0").replace(/١/g,"1").replace(/٢/g,"2").replace(/٣/g,"3").replace(/٤/g,"4").replace(/٥/g,"5").replace(/٦/g,"6").replace(/٧/g,"7").replace(/٨/g,"8").replace(/٩/g,"9"),g=(e,t,n,r,l,a)=>{return e=i(e),s(e)+" "+(2===e?"حرفين":2<e%100&&e%100<11?"أحرف":"حرف")+" في الدقيقة ("+s(i(t))+" ك/د بصحة "+s(i(l))+"٪)."},u=(e,t,n,r,l,a,o)=>"<br>تقدم إلى "+B(o+1)+" أو أعد "+B(o)+".",p=(e,t,n,r,l,a,o)=>"<br>لقد أنهيت جميع الدروس! يمكنك الانطلاق، أو إعادة "+B(o)+".",d=(e,t,n,r,l,a,o)=>"<br>ولكن بهذه الصحة القليلة، الأفضل أن تعيد "+B(o)+".",f=L.split(" ");function v(e){let t=e.length;for(var n;0!=t;)n=Math.floor(Math.random()*t),t--,[e[t],e[n]]=[e[n],e[t]];return e}const m=(e,t,n="")=>e.filter(e=>e.match(RegExp(`^[${t.replace(/-/g,"\\-")}]+$`))).filter(e=>!e.match(RegExp(`^[${n.replace(/-/g,"\\-")}]+$`))),F=e=>f[+e-1],N=e=>o(f[+e-1])?c:100,V=(e,t)=>{e=+e-1;var n=f[e],[r,l]=o(n)?[FULL_WORDS,c]:[a,100],t=t||l,l=f.slice(0,e).reduce((e,t)=>e+t,""),e=m(r,n,l);return v(e.length>=t?v(e).slice(0,t):[...e,...v(m(r,n)).slice(0,t-e.length)])},w=()=>(new Date).getTime(),j=e=>document.querySelector(e),r=e=>document.getElementById(e),b=e=>document.querySelectorAll(e),l=t=>b("."+t).forEach(e=>e.classList.remove(t)),y=n=>{n.innerHTML=n.innerText.split("").map(e=>`<span>${e}</span>`).join(""),n.childNodes.forEach((e,t)=>{0<t&&(n.childNodes[t-1].textContent+e.textContent).match(/ل[اأإآ]|[لم]م/)&&S(e,"bb")})},S=(e,t)=>e.classList.add(t),x=(e,t)=>e.classList.remove(t),E=e=>{S(e,"current-word"),y(e),e.scrollIntoView(),H=e},O=e=>{x(e,"wrong-letter"),S(e,"correct-letter")},P=e=>{S(e,"wrong-letter"),x(e,"correct-letter")},T=r("completed"),n=r("allwords"),U=r("lesson"),k=r("screen"),$=r("write"),C=document.body;let H,I={};function R(){var e,t;if(H)return(e=H.innerText)===(t=$.value)?" ":e.startsWith(t)?e[t.length]:"\b"}b("#keyboard > span > *").forEach(e=>{var t;I["BS"===(t=e.innerHTML)?"\b":"SPACE"===t?" ":t.startsWith("&nbsp;")?t.split(";").pop():t[0]]=e});const D=function(){let r;return{end:function(){clearInterval(r)},start:function(){clearInterval(r),l("hihi");var e,t=R();const n=I[t];n&&(e=()=>n.classList.add("hihi"),"\b"===t?e():r=setInterval(e,5e3))}}}();function W(e,t){t||=h(n.innerText);t=(--t).toString().length;T.innerText=s(e.toString().padStart(t,"0"))}const B=e=>'<a href="?'+e+'">'+t[+e-1]+"</a>";function play(o){var e;(o=!o||o<1?1:o)>=f.length&&(o=f.length),location.hash=o,location.search="",e=U.value=o,k.innerHTML=V(e).map(e=>`<span style="display: inline-block; width: ${.75*e.length}em">${e}</span>`).join(" "),W(0,e=N(e)),n.innerText=s(e),x(C,"finish"),l("hi"),F(o).split("").forEach(e=>I[e].classList.add("hi")),E(j("#screen > :first-child")),$.value="",$.focus(),D.start();let c,t,i=0;onblur=()=>{null!=c&&(t=w())},onfocus=()=>{null!=c&&(null==t?console.warn("How on Earth have you managed to start the lesson while not focusing the screen? Please share you wisdom and report this at https://github.com/noureddin/kbt"):c+=w()-t)},$.oninput=e=>{e=" "===e.data;null==c&&(c=w());var t,n,r=H.textContent,l=$.value.trim();$.value=l;for(let e=0;e<r.length;++e){var a=H.childNodes[e];null==l[e]?(x(a,"wrong-letter"),x(a,"correct-letter")):(r[e]!==l[e]?P:O)(a)}(l.length>r.length||b(".wrong-letter").length||"\b"===R()?S:x)(H,"wrong-word"),e?(e=r===l,H.innerHTML=H.textContent,e?(S(H,"correct-word"),x(H,"wrong-word"),x(H,"current-word"),(e=H.nextSibling?.nextSibling)?(W(h(T.innerText)+1),E(e)):(e=(w()-c)/1e3,n=k.innerText.length,S(C,"finish"),k.innerHTML=(n=[t=60*(n=n)/e,t/5,n,e,t=100-100*i/n,i,+(e=o)],g(...n)+(+e<f.length?u:p)(...n)+(90<=t?"":d(...n))),c=null,D.end(),$.oninput=null)):l?(S(H,"wrong-word"),y(H),i+=1):y(H),$.value=""):i+="\b"===R(),c&&D.start()}}function K(e,t){var n,r,l;t&&(n=e.selectionStart,l=e.selectionEnd,r=e.value.substring(0,n),l=e.value.substring(l,e.value.length),e.value=r+t+l,e.selectionStart=e.selectionEnd=n+t.length)}const q={Backquote:!0};"QWERTASDFGZXCVB".split("").forEach(e=>q["Key"+e]=!0);let A;$.onkeydown=e=>{var t,n=r("emu").checked;e.ctrlKey||e.altKey||("Shift"===e.key?A=e.code.substr(5,1):"Enter"===e.key?alert("اضغط زر المسافة بعد كل كلمة، فهو أسرع، وهو المعتاد"):n&&(n=M[e.code])&&(e.preventDefault(),e.shiftKey?(t=q[e.code])&&"L"===A?alert("استخدم زر العالي الأيمن مع الأزرار التي على يسار اللوحة"):t||"R"!==A?K($,n[1]):alert("استخدم زر العالي الأيسر مع الأزرار التي على يمين اللوحة"):K($,n[0]),$.oninput(e)))},onresize=()=>{H&&H.scrollIntoView()},onload=()=>{$.value="",play(+location.hash.slice(1)||+location.search.slice(1)||1)};